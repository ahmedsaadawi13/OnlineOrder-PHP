<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Food - Restaurant SaaS</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        
        body {
            background-color: #f8f9fa;
            padding-bottom: 100px;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        
        .menu-item-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            height: 100%;
        }
        
        .menu-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .cart-icon {
            position: relative;
        }
        
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .cart-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s;
            z-index: 1050;
            overflow-y: auto;
        }
        
        .cart-sidebar.show {
            right: 0;
        }
        
        .cart-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
        }
        
        .cart-overlay.show {
            display: block;
        }
        
        .category-badge {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category-badge.active {
            background: var(--primary-color) !important;
            color: white !important;
        }
        
        .price-tag {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .checkout-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .empty-cart {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-basket2-fill"></i>
                <span id="restaurantName">Restaurant</span>
            </a>
            <button class="btn btn-light position-relative" onclick="toggleCart()">
                <i class="bi bi-cart3"></i>
                <span class="cart-badge" id="cartBadge">0</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Categories -->
        <div class="mb-4" id="categoriesContainer">
            <div class="d-flex gap-2 flex-wrap" id="categories">
                <!-- Categories loaded here -->
            </div>
        </div>

        <!-- Menu Items -->
        <div class="row g-4" id="menuContainer">
            <div class="col-12 loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading menu...</p>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Your Cart</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleCart()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div id="cartItems" class="p-3">
            <div class="empty-cart">
                <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                <p class="mt-2">Your cart is empty</p>
            </div>
        </div>
        
        <div class="border-top p-3">
            <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span id="subtotal">$0.00</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>Tax (8%):</span>
                <span id="tax">$0.00</span>
            </div>
            <div class="d-flex justify-content-between mb-3 fw-bold">
                <span>Total:</span>
                <span id="total">$0.00</span>
            </div>
            <button class="btn checkout-btn w-100" onclick="checkout()" id="checkoutBtn" disabled>
                Proceed to Checkout
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Checkout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Customer Info -->
                    <h6 class="mb-3">Customer Information</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="firstName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="lastName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone *</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                    </div>

                    <!-- Delivery Address -->
                    <h6 class="mb-3">Delivery Address</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Street Address *</label>
                            <input type="text" class="form-control" id="address" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Postal Code *</label>
                            <input type="text" class="form-control" id="postalCode" required>
                        </div>
                    </div>

                    <!-- Payment -->
                    <h6 class="mb-3">Payment Information</h6>
                    <div id="payment-element"></div>
                    <div id="payment-message" class="alert alert-danger mt-3 d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processPayment()" id="payBtn">
                        <span id="payBtnText">Pay $<span id="payAmount">0.00</span></span>
                        <span id="paySpinner" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                    <h3 class="mt-3">Order Placed Successfully!</h3>
                    <p class="text-muted">Order Number: <strong id="orderNumber"></strong></p>
                    <p>We'll start preparing your order shortly.</p>
                    <button class="btn btn-primary mt-3" onclick="location.reload()">Place Another Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
        // Configuration
        const API_BASE = window.location.origin + '/api/v1';
        const TENANT_ID = 1; // TODO: Get from URL or config
        const BRANCH_ID = 1; // TODO: Get from selected branch
        
        // State
        let cart = [];
        let categories = [];
        let menuItems = [];
        let selectedCategory = null;
        let stripe = null;
        let elements = null;
        let clientSecret = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Load menu
            await loadCategories();
            await loadMenuItems();
            
            // Initialize Stripe
            stripe = Stripe('pk_test_51QbUE5RugHnPHm6l1234567890abcdefghijklmnop'); // TODO: Use real key
        });
        
        // Load Categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const data = await response.json();
                
                if (data.success) {
                    categories = data.data;
                    renderCategories();
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }
        
        // Render Categories
        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = `
                <span class="badge bg-secondary category-badge active" onclick="filterCategory(null)">
                    All Items
                </span>
            `;
            
            categories.forEach(cat => {
                container.innerHTML += `
                    <span class="badge bg-light text-dark category-badge" onclick="filterCategory(${cat.id})">
                        ${cat.name}
                    </span>
                `;
            });
        }
        
        // Filter by Category
        function filterCategory(categoryId) {
            selectedCategory = categoryId;
            
            // Update active badge
            document.querySelectorAll('.category-badge').forEach(badge => {
                badge.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderMenuItems();
        }
        
        // Load Menu Items
        async function loadMenuItems() {
            try {
                const response = await fetch(`${API_BASE}/menu-items`);
                const data = await response.json();
                
                if (data.success) {
                    menuItems = data.data;
                    renderMenuItems();
                }
            } catch (error) {
                console.error('Failed to load menu items:', error);
                document.getElementById('menuContainer').innerHTML = `
                    <div class="col-12 text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Failed to load menu. Please refresh the page.
                    </div>
                `;
            }
        }
        
        // Render Menu Items
        function renderMenuItems() {
            const container = document.getElementById('menuContainer');
            const items = selectedCategory 
                ? menuItems.filter(item => item.category_id == selectedCategory)
                : menuItems;
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted">
                        <i class="bi bi-basket"></i>
                        <p>No items found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="col-md-6 col-lg-4">
                    <div class="card menu-item-card h-100" onclick="addToCart(${item.id})">
                        <div class="card-body">
                            <h5 class="card-title">${item.name}</h5>
                            <p class="card-text text-muted small">${item.description || 'Delicious food item'}</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="price-tag">$${parseFloat(item.price).toFixed(2)}</span>
                                <button class="btn btn-sm btn-primary">
                                    <i class="bi bi-plus-circle"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Add to Cart
        function addToCart(itemId) {
            const item = menuItems.find(i => i.id == itemId);
            if (!item) return;
            
            const existingItem = cart.find(i => i.id == itemId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    ...item,
                    quantity: 1
                });
            }
            
            updateCart();
            
            // Show notification
            const toast = document.createElement('div');
            toast.className = 'toast position-fixed bottom-0 end-0 m-3';
            toast.innerHTML = `
                <div class="toast-body bg-success text-white">
                    Added ${item.name} to cart!
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        // Update Cart
        function updateCart() {
            const badge = document.getElementById('cartBadge');
            const itemsContainer = document.getElementById('cartItems');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            badge.textContent = itemCount;
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                        <p class="mt-2">Your cart is empty</p>
                    </div>
                `;
                checkoutBtn.disabled = true;
                updateTotals(0, 0, 0);
                return;
            }
            
            checkoutBtn.disabled = false;
            
            itemsContainer.innerHTML = cart.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${item.name}</h6>
                        <small class="text-muted">$${parseFloat(item.price).toFixed(2)} each</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${item.id}, -1)">
                            <i class="bi bi-dash"></i>
                        </button>
                        <span class="px-2">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${item.id}, 1)">
                            <i class="bi bi-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Calculate totals
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.08;
            const total = subtotal + tax;
            
            updateTotals(subtotal, tax, total);
        }
        
        // Update Totals
        function updateTotals(subtotal, tax, total) {
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
            document.getElementById('payAmount').textContent = total.toFixed(2);
        }
        
        // Update Quantity
        function updateQuantity(itemId, change) {
            const item = cart.find(i => i.id == itemId);
            if (!item) return;
            
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(itemId);
                return;
            }
            
            updateCart();
        }
        
        // Remove from Cart
        function removeFromCart(itemId) {
            cart = cart.filter(i => i.id != itemId);
            updateCart();
        }
        
        // Toggle Cart
        function toggleCart() {
            const sidebar = document.getElementById('cartSidebar');
            const overlay = document.getElementById('cartOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }
        
        // Checkout
        async function checkout() {
            if (cart.length === 0) return;
            
            const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
            modal.show();
            
            // Create order first (without payment)
            // Then create payment intent
            // This will be implemented in processPayment()
        }
        
        // Process Payment
        async function processPayment() {
            // Validate form
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const postalCode = document.getElementById('postalCode').value;
            
            if (!firstName || !lastName || !email || !phone || !address || !city || !postalCode) {
                showPaymentMessage('Please fill in all required fields', 'danger');
                return;
            }
            
            const payBtn = document.getElementById('payBtn');
            const payBtnText = document.getElementById('payBtnText');
            const paySpinner = document.getElementById('paySpinner');
            
            payBtn.disabled = true;
            payBtnText.classList.add('d-none');
            paySpinner.classList.remove('d-none');
            
            try {
                // 1. Register customer
                const customerData = {
                    first_name: firstName,
                    last_name: lastName,
                    email: email,
                    phone: phone,
                    password: 'temp' + Math.random().toString(36),
                    password_confirmation: 'temp' + Math.random().toString(36)
                };
                
                // 2. Create order
                const orderData = {
                    branch_id: BRANCH_ID,
                    order_type: 'delivery',
                    items: cart.map(item => ({
                        item_id: item.id,
                        quantity: item.quantity
                    }))
                };
                
                // For demo: Just show success
                setTimeout(() => {
                    document.getElementById('checkoutModal').querySelector('[data-bs-dismiss="modal"]').click();
                    document.getElementById('orderNumber').textContent = 'ORD-' + Date.now();
                    new bootstrap.Modal(document.getElementById('successModal')).show();
                    cart = [];
                    updateCart();
                }, 2000);
                
            } catch (error) {
                console.error('Payment failed:', error);
                showPaymentMessage('Payment failed. Please try again.', 'danger');
            } finally {
                payBtn.disabled = false;
                payBtnText.classList.remove('d-none');
                paySpinner.classList.add('d-none');
            }
        }
        
        // Show Payment Message
        function showPaymentMessage(message, type = 'danger') {
            const messageEl = document.getElementById('payment-message');
            messageEl.textContent = message;
            messageEl.className = `alert alert-${type} mt-3`;
            messageEl.classList.remove('d-none');
            
            setTimeout(() => {
                messageEl.classList.add('d-none');
            }, 5000);
        }
    </script>
</body>
</html>
